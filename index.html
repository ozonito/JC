<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Flashcards - Quiz Tributario</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #eeeeff;
            --text-secondary: #94a3b8;
            --accent: #e94560;
            --success: #4ade80;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--accent);
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .section {
            background-color: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        select, button, input[type="file"], textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        textarea {
            min-height: 100px;
            font-family: monospace;
            resize: vertical;
        }

        select:hover, button:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        button {
            background-color: var(--accent);
            border: none;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            background-color: #c93651;
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .debug-section {
            background-color: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }

        .debug-title {
            color: var(--warning);
            font-weight: bold;
            margin-bottom: 8px;
        }

        .debug-content {
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            overflow-x: auto;
            color: var(--text-secondary);
        }

        .success-button {
            background-color: var(--success);
        }

        .warning-button {
            background-color: var(--warning);
        }

        .error-button {
            background-color: var(--error);
        }

        .hidden {
            display: none !important;
        }

        .info-text {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin: 10px 0;
        }

        .error-text {
            color: var(--error);
            background-color: rgba(239, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success-text {
            color: var(--success);
            background-color: rgba(74, 222, 128, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .format-info {
            background-color: rgba(79, 70, 229, 0.1);
            border-left: 4px solid #4f46e5;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .delimiter-options {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .delimiter-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delimiter-option:hover, .delimiter-option.active {
            border-color: var(--accent);
            background-color: rgba(233, 69, 96, 0.2);
        }

        .delimiter-option.active {
            background-color: rgba(233, 69, 96, 0.3);
            font-weight: bold;
        }

        .manual-input-section textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Estilos para la secci√≥n de quiz */
        .quiz-section {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-secondary);
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
        }

        .question-counter {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .options-container {
            display: grid;
            gap: 15px;
        }

        .option-button {
            text-align: left;
            padding: 15px;
            background-color: var(--bg-secondary);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .option-button:hover:not(:disabled) {
            border-color: var(--accent);
            background-color: rgba(233, 69, 96, 0.1);
        }

        .option-button.correct {
            background-color: rgba(74, 222, 128, 0.2);
            border-color: var(--success);
        }

        .option-button.incorrect {
            background-color: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .feedback.success {
            background-color: rgba(74, 222, 128, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .feedback.error {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .feedback a {
            color: inherit;
            text-decoration: underline;
        }

        .motivational-message {
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
            margin-top: 15px;
            font-size: 1.1em;
        }

        /* Estilos para la secci√≥n de resultados */
        .results-section {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .review-list {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .review-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .occurrence-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .occurrence-table th, .occurrence-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .occurrence-table th {
            background-color: var(--bg-card);
            color: var(--accent);
            font-weight: bold;
        }

        .occurrence-table tr:hover {
            background-color: rgba(233, 69, 96, 0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: var(--accent);
        }

        .tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .question-text {
                font-size: 1.1em;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Sistema de Flashcards Tributarias</h1>
        
        <!-- Secci√≥n de configuraci√≥n inicial y carga de CSV -->
        <div id="configSection" class="section">
            <h2>Cargar Preguntas</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="file-tab">Archivo CSV</div>
                <div class="tab" data-tab="text-tab">Entrada Manual</div>
            </div>
            
            <div id="file-tab" class="tab-content">
                <div class="form-group">
                    <label for="csvFile">Seleccionar archivo CSV:</label>
                    <input type="file" id="csvFile" accept=".csv" />
                    <div id="fileInfo" class="info-text">Seleccione un archivo CSV con las preguntas para el quiz</div>
                </div>

                <div class="format-info">
                    <p><strong>Formato esperado del CSV:</strong></p>
                    <p>El archivo debe tener una de las siguientes estructuras:</p>
                    <p>1. Pregunta,Opci√≥n A,Opci√≥n B,Opci√≥n C,Opci√≥n D,Respuesta Correcta,Explicaci√≥n</p>
                    <p>2. ID,Pregunta,Opci√≥n A,Opci√≥n B,Opci√≥n C,Opci√≥n D,Respuesta Correcta,Explicaci√≥n</p>
                    <p>La respuesta correcta puede ser: A, B, C, D o 0, 1, 2, 3</p>
                </div>
                
                <div class="form-group">
                    <label>Seleccione el delimitador:</label>
                    <div class="delimiter-options">
                        <div class="delimiter-option active" data-delimiter=",">Coma (,)</div>
                        <div class="delimiter-option" data-delimiter=";">Punto y coma (;)</div>
                        <div class="delimiter-option" data-delimiter="\t">Tabulador</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="encodingSelect">Codificaci√≥n:</label>
                    <select id="encodingSelect">
                        <option value="utf-8">UTF-8</option>
                        <option value="iso-8859-1">ISO-8859-1 (Latin-1)</option>
                        <option value="windows-1252">Windows-1252</option>
                    </select>
                </div>
            </div>
            
            <div id="text-tab" class="tab-content hidden">
                <div class="form-group">
                    <label for="manualInput">Pegue sus preguntas en formato CSV:</label>
                    <textarea id="manualInput" placeholder="Pregunta,Opci√≥n A,Opci√≥n B,Opci√≥n C,Opci√≥n D,Respuesta Correcta,Explicaci√≥n"></textarea>
                    <div class="info-text">Aseg√∫rese de usar el mismo formato que se indica arriba</div>
                </div>
            </div>
            
            <div class="form-group">
                <button id="analyzeButton" class="warning-button">üîç Analizar Datos</button>
                <button id="processCSVButton" class="success-button" disabled>‚úÖ Procesar Preguntas</button>
                <div id="processResult" class="info-text"></div>
            </div>
            
            <div id="debugSection" class="debug-section hidden">
                <div class="debug-title">Diagn√≥stico de Datos:</div>
                <div id="debugContent" class="debug-content"></div>
            </div>
            
            <div id="quizOptionsSection" class="hidden">
                <h3>Configurar Quiz</h3>
                
                <div class="form-group">
                    <label for="numQuestions">N√∫mero de preguntas:</label>
                    <select id="numQuestions">
                        <option value="5">5 preguntas</option>
                        <option value="10">10 preguntas</option>
                        <option value="15">15 preguntas</option>
                        <option value="20">20 preguntas</option>
                        <option value="25">25 preguntas</option>
                        <option value="30">30 preguntas</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category">Bloque tem√°tico:</label>
                    <select id="category">
                        <option value="TODO">Todas las categor√≠as</option>
                        <option value="administrativo">Administrativo</option>
                        <option value="civil">Civil</option>
                        <option value="mercantil">Mercantil</option>
                    </select>
                </div>
                
                <button id="startQuizButton">üöÄ Comenzar Quiz</button>
                <button id="resetDataButton" class="warning-button">üîÑ Reiniciar historial de preguntas</button>
            </div>
        </div>
        
        <!-- Secci√≥n del quiz -->
        <div id="quizSection" class="section quiz-section">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div id="questionCounter" class="question-counter"></div>
            
            <div id="questionText" class="question-text"></div>
            
            <div id="optionsContainer" class="options-container"></div>
            
            <div id="feedback" class="feedback"></div>
            
            <div id="motivationalMessage" class="motivational-message"></div>
            
            <button id="nextButton" class="hidden">Siguiente pregunta ‚û°Ô∏è</button>
        </div>
        
        <!-- Secci√≥n de resultados -->
        <div id="resultsSection" class="section results-section">
            <h2>üìä Resultados del Quiz</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">Respuestas Correctas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="incorrectCount">0</div>
                    <div class="stat-label">Respuestas Incorrectas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="scorePercentage">0%</div>
                    <div class="stat-label">Puntuaci√≥n</div>
                </div>
            </div>
            
            <div id="reviewList" class="review-list">
                <h3>üìù Temas a repasar:</h3>
                <div id="reviewItems"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>üìà Estad√≠sticas de uso de preguntas:</h3>
                <table class="occurrence-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Pregunta</th>
                            <th>Veces mostrada</th>
                        </tr>
                    </thead>
                    <tbody id="occurrenceTableBody"></tbody>
                </table>
            </div>
            
            <div id="finalMessage" class="motivational-message" style="margin-top: 30px; font-size: 1.2em;"></div>
            
            <button id="newQuizButton">üîÑ Nuevo Quiz</button>
        </div>
    </div>

    <script>
        // Variables globales
        let questionsDB = [];
        let rawCSVContent = '';
        let csvText = '';
        let selectedDelimiter = ',';
        let selectedEncoding = 'utf-8';
        let activeTab = 'file-tab';
        
        // Sistema de tracking
        const TRACKING_VERSION = '3.0';
        let advancedTracking = {
            version: TRACKING_VERSION,
            occurrences: {},
            sessionHistory: [],
            lastShown: {},
            cooldownPeriod: 3,
            maxSessionHistory: 10
        };
        
        // Variables para el quiz actual
        let currentQuiz = {
            questions: [],
            currentIndex: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            reviewItems: [],
            startTime: null,
            endTime: null
        };

        // Frases motivacionales
        const motivationalPhrases = {
            correct: [
                "¬°Excelente! üéâ Vas por el camino correcto.",
                "¬°Brillante! ‚≠ê Tu conocimiento es impresionante.",
                "¬°Genial! üöÄ Sigue as√≠, lo est√°s haciendo muy bien.",
                "¬°Fant√°stico! üí™ Tu esfuerzo est√° dando frutos.",
                "¬°Muy bien! üåü Cada respuesta correcta te acerca m√°s a tu objetivo."
            ],
            incorrect: [
                "No te preocupes üíô Cada error es una oportunidad de aprendizaje.",
                "¬°√Ånimo! üåà La pr√≥xima vez lo har√°s mejor.",
                "Sigue adelante üí™ El conocimiento se construye paso a paso.",
                "¬°No te rindas! üî• Los grandes expertos tambi√©n se equivocan.",
                "Tranquilo/a üåü Est√°s aprendiendo y eso es lo importante."
            ],
            final: [
                "¬°Has completado el quiz! üéä Tu dedicaci√≥n es admirable.",
                "¬°Felicidades por llegar hasta aqu√≠! üèÜ Cada pregunta te ha hecho m√°s fuerte.",
                "¬°Excelente trabajo! üåü Tu perseverancia es tu mayor fortaleza.",
                "¬°Lo has logrado! üöÄ Contin√∫a con esta actitud positiva.",
                "¬°Bravo! üí™ Has demostrado compromiso y determinaci√≥n."
            ]
        };

        // Referencias a elementos DOM
        const elements = {
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            fileTab: document.getElementById('file-tab'),
            textTab: document.getElementById('text-tab'),
            
            // Inputs
            csvFile: document.getElementById('csvFile'),
            manualInput: document.getElementById('manualInput'),
            encodingSelect: document.getElementById('encodingSelect'),
            
            // Information displays
            fileInfo: document.getElementById('fileInfo'),
            processResult: document.getElementById('processResult'),
            debugSection: document.getElementById('debugSection'),
            debugContent: document.getElementById('debugContent'),
            
            // Buttons
            analyzeButton: document.getElementById('analyzeButton'),
            processCSVButton: document.getElementById('processCSVButton'),
            startQuizButton: document.getElementById('startQuizButton'),
            resetDataButton: document.getElementById('resetDataButton'),
            nextButton: document.getElementById('nextButton'),
            newQuizButton: document.getElementById('newQuizButton'),
            
            // Sections
            quizOptionsSection: document.getElementById('quizOptionsSection'),
            configSection: document.getElementById('configSection'),
            quizSection: document.getElementById('quizSection'),
            resultsSection: document.getElementById('resultsSection'),
            
            // Quiz elements
            questionCounter: document.getElementById('questionCounter'),
            questionText: document.getElementById('questionText'),
            optionsContainer: document.getElementById('optionsContainer'),
            feedback: document.getElementById('feedback'),
            motivationalMessage: document.getElementById('motivationalMessage'),
            progressFill: document.getElementById('progressFill'),
            
            // Results elements
            correctCount: document.getElementById('correctCount'),
            incorrectCount: document.getElementById('incorrectCount'),
            scorePercentage: document.getElementById('scorePercentage'),
            reviewItems: document.getElementById('reviewItems'),
            occurrenceTableBody: document.getElementById('occurrenceTableBody'),
            finalMessage: document.getElementById('finalMessage')
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos de tracking
            loadAdvancedTracking();
            
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });
            
            // Listener para selecci√≥n de archivo CSV
            elements.csvFile.addEventListener('change', handleFileSelection);
            
            // Listener para cambio de codificaci√≥n
            elements.encodingSelect.addEventListener('change', function() {
                selectedEncoding = this.value;
                if (rawCSVContent) {
                    try {
                        const decoder = new TextDecoder(selectedEncoding);
                        csvText = decoder.decode(rawCSVContent);
                        elements.fileInfo.textContent = 'Archivo cargado. Haga clic en "Analizar Datos" para continuar.';
                        elements.fileInfo.className = 'info-text';
                        elements.analyzeButton.disabled = false;
                    } catch (error) {
                        showError(`Error al decodificar el archivo: ${error.message}`);
                    }
                }
            });
            
            // Listeners para opciones de delimitador
            document.querySelectorAll('.delimiter-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.delimiter-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    selectedDelimiter = this.dataset.delimiter;
                });
            });
            
            // Listener para an√°lisis de datos
            elements.analyzeButton.addEventListener('click', analyzeData);
            
            // Listener para procesar datos
            elements.processCSVButton.addEventListener('click', processCSV);
            
            // Listener para iniciar quiz
            elements.startQuizButton.addEventListener('click', startQuiz);
            
            // Listener para reiniciar datos
            elements.resetDataButton.addEventListener('click', resetAllData);
            
            // Listener para siguiente pregunta
            elements.nextButton.addEventListener('click', nextQuestion);
            
            // Listener para nuevo quiz
            elements.newQuizButton.addEventListener('click', resetQuiz);
            
            // Listener para entrada manual
            elements.manualInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    csvText = this.value;
                    elements.analyzeButton.disabled = false;
                } else {
                    elements.analyzeButton.disabled = true;
                }
            });
        });

        // Funci√≥n para cambiar entre pesta√±as
        function switchTab(tabId) {
            // Actualizar pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Actualizar contenido
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
            
            activeTab = tabId;
            
            // Resetear algunos estados
            elements.analyzeButton.disabled = (tabId === 'file-tab' && !rawCSVContent) || 
                                             (tabId === 'text-tab' && !elements.manualInput.value.trim());
            elements.processCSVButton.disabled = true;
            elements.processResult.textContent = '';
            elements.debugSection.classList.add('hidden');
        }

        // Funci√≥n para manejar la selecci√≥n de archivo
        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            elements.fileInfo.textContent = `Archivo seleccionado: ${file.name}`;
            elements.fileInfo.className = 'info-text';
            elements.processCSVButton.disabled = true;
            elements.debugSection.classList.add('hidden');
            
            // Leer el archivo como ArrayBuffer para manejar correctamente la codificaci√≥n
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    rawCSVContent = new Uint8Array(e.target.result);
                    const decoder = new TextDecoder(selectedEncoding);
                    csvText = decoder.decode(rawCSVContent);
                    elements.fileInfo.textContent = 'Archivo cargado. Haga clic en "Analizar Datos" para continuar.';
                    elements.analyzeButton.disabled = false;
                } catch (error) {
                    showError(`Error al leer el archivo: ${error.message}`);
                }
            };
            reader.onerror = function() {
                showError('Error al leer el archivo.');
            };
            reader.readAsArrayBuffer(file);
        }

        // Funci√≥n para analizar los datos CSV
        function analyzeData() {
            elements.debugSection.classList.remove('hidden');
            elements.debugContent.textContent = "Analizando datos...";
            
            try {
                // Obtener el texto CSV dependiendo de la pesta√±a activa
                let text = csvText;
                if (activeTab === 'text-tab') {
                    text = elements.manualInput.value;
                }
                
                if (!text || text.trim().length === 0) {
                    elements.debugContent.textContent = "Error: No hay datos para analizar.";
                    return;
                }
                
                // Limpiar el texto
                text = text.trim();
                
                // Reemplazar diferentes tipos de saltos de l√≠nea
                text = text.replace(/\r\n/g, '\n');
                text = text.replace(/\r/g, '\n');
                
                // Dividir por l√≠neas
                let lines = text.split('\n');
                lines = lines.filter(line => line.trim().length > 0);
                
                if (lines.length === 0) {
                    elements.debugContent.textContent = "Error: No se encontraron l√≠neas v√°lidas en el texto.";
                    return;
                }
                
                // Analizar primera l√≠nea para detectar estructura
                const firstLine = lines[0];
                const rawDelimiter = selectedDelimiter === '\\t' ? '\t' : selectedDelimiter;
                const firstLineParts = parseCSVLine(firstLine, rawDelimiter);
                
                let columnCount = firstLineParts.length;
                let hasHeader = detectHeader(firstLine);
                let format = detectFormat(firstLineParts);
                
                // Analizar algunas l√≠neas m√°s para verificar consistencia
                let lineAnalysis = [];
                for (let i = 0; i < Math.min(5, lines.length); i++) {
                    const line = lines[i];
                    const parts = parseCSVLine(line, rawDelimiter);
                    lineAnalysis.push({
                        index: i,
                        columns: parts.length,
                        content: parts.map(p => p.length > 20 ? p.substring(0, 20) + '...' : p)
                    });
                }
                
                // Determinar el n√∫mero de columnas esperado
                let expectedColumns = format === 'unknown' ? 7 : format === 'with_id' ? 8 : 7;
                
                // Mostrar an√°lisis
                let debugText = `An√°lisis de datos CSV:\n\n`;
                debugText += `- Total de l√≠neas: ${lines.length}\n`;
                debugText += `- Delimitador utilizado: "${rawDelimiter === '\t' ? 'Tab' : rawDelimiter}"\n`;
                debugText += `- Formato detectado: ${format}\n`;
                debugText += `- Encabezado detectado: ${hasHeader ? 'S√≠' : 'No'}\n`;
                debugText += `- Columnas en primera l√≠nea: ${columnCount}\n`;
                debugText += `- Columnas esperadas: ${expectedColumns}\n\n`;
                
                debugText += `An√°lisis de primeras l√≠neas:\n`;
                lineAnalysis.forEach(line => {
                    debugText += `L√≠nea ${line.index + 1}: ${line.columns} columnas\n`;
                    if (line.columns !== expectedColumns) {
                        debugText += `  ‚ö†Ô∏è Esta l√≠nea tiene un n√∫mero diferente de columnas (${line.columns} vs ${expectedColumns})\n`;
                    }
                    debugText += `  Contenido: ${JSON.stringify(line.content)}\n`;
                });
                
                elements.debugContent.textContent = debugText;
                
                // Verificar si hay problemas graves
                let hasErrors = false;
                let allDifferentColumns = lineAnalysis.some(line => line.columns !== expectedColumns);
                
                if (allDifferentColumns) {
                    elements.processResult.textContent = "‚ö†Ô∏è Advertencia: Algunas l√≠neas tienen un n√∫mero incorrecto de columnas. Revise el an√°lisis.";
                    elements.processResult.className = 'error-text';
                } else {
                    elements.processResult.textContent = "‚úÖ Datos analizados correctamente. Puede procesar el archivo para iniciar el quiz.";
                    elements.processResult.className = 'success-text';
                }
                
                // Habilitar bot√≥n de procesamiento
                elements.processCSVButton.disabled = false;
                
            } catch (error) {
                elements.debugContent.textContent = `Error durante el an√°lisis: ${error.message}\n\n${error.stack}`;
                showError(`Error al analizar los datos: ${error.message}`);
            }
        }

        // Funci√≥n para detectar si hay encabezado
        function detectHeader(line) {
            const lowercaseLine = line.toLowerCase();
            return lowercaseLine.includes('pregunta') || 
                  lowercaseLine.includes('enunciado') ||
                  lowercaseLine.includes('question') ||
                  lowercaseLine.includes('opcion');
        }

        // Funci√≥n para detectar el formato del CSV
        function detectFormat(parts) {
            if (parts.length === 0) return 'unknown';
            
            // Verificar si la primera columna parece un ID num√©rico
            const firstCol = parts[0].trim();
            const isNumeric = !isNaN(firstCol) && firstCol !== '';
            
            if (isNumeric && parts.length >= 8) {
                return 'with_id';
            } else if (parts.length >= 7) {
                return 'without_id';
            } else {
                return 'unknown';
            }
        }

        // Funci√≥n para procesar el CSV completo
        function processCSV() {
            try {
                elements.processResult.textContent = 'Procesando...';
                elements.processResult.className = 'info-text';
                
                // Obtener el texto CSV dependiendo de la pesta√±a activa
                let text = csvText;
                if (activeTab === 'text-tab') {
                    text = elements.manualInput.value;
                }
                
                // Limpiar el texto
                text = text.trim();
                
                // Reemplazar diferentes tipos de saltos de l√≠nea
                text = text.replace(/\r\n/g, '\n');
                text = text.replace(/\r/g, '\n');
                
                // Dividir por l√≠neas
                let lines = text.split('\n');
                lines = lines.filter(line => line.trim().length > 0);
                
                if (lines.length === 0) {
                    showError('El archivo est√° vac√≠o.');
                    return;
                }
                
                // Detectar si hay encabezado
                const firstLine = lines[0];
                const hasHeader = detectHeader(firstLine);
                const startIndex = hasHeader ? 1 : 0;
                
                // Convertir el delimitador
                const rawDelimiter = selectedDelimiter === '\\t' ? '\t' : selectedDelimiter;
                
                questionsDB = [];
                
                // Procesar cada l√≠nea
                for (let i = startIndex; i < lines.length; i++) {
                    try {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = parseCSVLine(line, rawDelimiter);
                        
                        // Determinar formato basado en las partes
                        let question = null;
                        const format = detectFormat(parts);
                        
                        if (format === 'with_id' && parts.length >= 8) {
                            // Formato: ID, Pregunta, A, B, C, D, Respuesta, Razonamiento
                            question = {
                                id: parseInt(parts[0]) || i,
                                question: parts[1].trim(),
                                options: [
                                    parts[2].trim(),
                                    parts[3].trim(),
                                    parts[4].trim(),
                                    parts[5].trim()
                                ],
                                correctAnswer: parseCorrectAnswer(parts[6]),
                                reasoning: parts[7] ? parts[7].trim() : 'Sin explicaci√≥n disponible',
                                category: detectCategory(parts[1]),
                                legalReference: parts[7] ? extractLegalReference(parts[7]) : ''
                            };
                        } else if (format === 'unknown' || format === 'without_id') {
                            if (parts.length >= 7) {
                                // Formato: Pregunta, A, B, C, D, Respuesta, Razonamiento
                                question = {
                                    id: i,
                                    question: parts[0].trim(),
                                    options: [
                                        parts[1].trim(),
                                        parts[2].trim(),
                                        parts[3].trim(),
                                        parts[4].trim()
                                    ],
                                    correctAnswer: parseCorrectAnswer(parts[5]),
                                    reasoning: parts[6] ? parts[6].trim() : 'Sin explicaci√≥n disponible',
                                    category: detectCategory(parts[0]),
                                    legalReference: parts[6] ? extractLegalReference(parts[6]) : ''
                                };
                            } else if (parts.length >= 6) {
                                // Formato m√≠nimo: Pregunta, A, B, C, D, Respuesta
                                question = {
                                    id: i,
                                    question: parts[0].trim(),
                                    options: [
                                        parts[1].trim(),
                                        parts[2].trim(),
                                        parts[3].trim(),
                                        parts[4].trim()
                                    ],
                                    correctAnswer: parseCorrectAnswer(parts[5]),
                                    reasoning: 'Sin explicaci√≥n disponible',
                                    category: detectCategory(parts[0]),
                                    legalReference: ''
                                };
                            }
                        }
                        
                        // Validar pregunta
                        if (question && isValidQuestion(question)) {
                            questionsDB.push(question);
                        } else {
                            console.warn(`Pregunta inv√°lida en l√≠nea ${i+1}`);
                        }
                    } catch (lineError) {
                        console.error(`Error en l√≠nea ${i+1}:`, lineError);
                    }
                }
                
                if (questionsDB.length > 0) {
                    // Inicializar tracking
                    initializeTracking();
                    
                    elements.processResult.textContent = `¬°√âxito! Se han cargado ${questionsDB.length} preguntas.`;
                    elements.processResult.className = 'success-text';
                    elements.quizOptionsSection.classList.remove('hidden');
                } else {
                    showError(`No se pudieron cargar preguntas v√°lidas. Por favor, revise el formato del archivo.
Si est√° seguro de que el formato es correcto, pruebe con otro delimitador o codificaci√≥n.`);
                }
                
            } catch (error) {
                console.error('Error al procesar el archivo:', error);
                showError(`Error al procesar el archivo: ${error.message}`);
            }
        }

        // Funci√≥n mejorada para parsear una l√≠nea CSV
        function parseCSVLine(line, delimiter) {
            if (!line) return [];
            
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        // Comillas dobles escapadas dentro de comillas
                        current += '"';
                        i += 2;
                    } else {
                        // Cambiar estado de comillas
                        inQuotes = !inQuotes;
                        i++;
                    }
                } else if (char === delimiter && !inQuotes) {
                    // Delimitador fuera de comillas
                    result.push(current);
                    current = '';
                    i++;
                } else {
                    current += char;
                    i++;
                }
            }
            
            // A√±adir el √∫ltimo campo
            result.push(current);
            
            return result;
        }

        // Funci√≥n para parsear la respuesta correcta
        function parseCorrectAnswer(answer) {
            if (!answer) return 0;
            
            answer = answer.toString().trim().toUpperCase();
            
            // Si es una letra A, B, C, D
            if (answer.match(/^[A-D]$/)) {
                return answer.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
            }
            
            // Si es un n√∫mero 0-3
            const num = parseInt(answer);
            if (!isNaN(num) && num >= 0 && num <= 3) {
                return num;
            }
            
            // Si contiene una letra A, B, C, D en alguna parte
            const match = answer.match(/[A-D]/);
            if (match) {
                return match[0].charCodeAt(0) - 65;
            }
            
            return 0; // Por defecto, la primera opci√≥n
        }

        // Funci√≥n para validar una pregunta
        function isValidQuestion(question) {
            return question.question && 
                   question.question.length > 3 &&
                   question.options.length === 4 &&
                   question.options.every(opt => opt && opt.length > 0) &&
                   question.correctAnswer >= 0 && 
                   question.correctAnswer <= 3;
        }

        // Funci√≥n para detectar categor√≠a
        function detectCategory(questionText) {
            if (!questionText) return 'administrativo';
            
            const text = questionText.toLowerCase();
            if (text.includes('tribut') || text.includes('fiscal') || 
                text.includes('impuesto') || text.includes('liquidaci√≥n') || 
                text.includes('retenci√≥n')) {
                return 'administrativo';
            } else if (text.includes('civil') || text.includes('propiedad') || 
                      text.includes('contrato') || text.includes('herencia')) {
                return 'civil';
            } else if (text.includes('mercantil') || text.includes('sociedad') || 
                      text.includes('comerci') || text.includes('empresa')) {
                return 'mercantil';
            }
            return 'administrativo'; // Categor√≠a por defecto
        }

        // Funci√≥n para extraer referencia legal
        function extractLegalReference(reasoning) {
            if (!reasoning) return '';
            
            const matches = reasoning.match(/https?:\/\/[^\s]+/);
            if (matches) {
                return matches[0];
            }
            
            const articleMatch = reasoning.match(/art√≠culo\s+(\d+)/i);
            if (articleMatch) {
                return `https://www.boe.es/buscar/act.php?id=BOE-A-2003-17588#a${articleMatch[1]}`;
            }
            
            return '';
        }

        // Funci√≥n para mostrar error
        function showError(message) {
            elements.processResult.textContent = message;
            elements.processResult.className = 'error-text';
        }

        // Funci√≥n para mostrar √©xito
        function showSuccess(message) {
            elements.processResult.textContent = message;
            elements.processResult.className = 'success-text';
        }

        // Funciones de tracking avanzado
        function loadAdvancedTracking() {
            try {
                const saved = localStorage.getItem('advancedQuestionTracking');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.version === TRACKING_VERSION) {
                        advancedTracking = parsed;
                    } else {
                        // Migrar datos antiguos
                        advancedTracking = {
                            version: TRACKING_VERSION,
                            occurrences: parsed.occurrences || {},
                            sessionHistory: parsed.sessionHistory || [],
                            lastShown: parsed.lastShown || {},
                            cooldownPeriod: 3,
                            maxSessionHistory: 10
                        };
                        saveAdvancedTracking();
                    }
                }
            } catch (e) {
                console.error('Error cargando datos de tracking:', e);
                initializeTracking();
            }
        }

        function initializeTracking() {
            questionsDB.forEach(q => {
                if (!advancedTracking.occurrences[q.id]) {
                    advancedTracking.occurrences[q.id] = 0;
                }
                if (!advancedTracking.lastShown[q.id]) {
                    advancedTracking.lastShown[q.id] = 0;
                }
            });
            saveAdvancedTracking();
        }

        function saveAdvancedTracking() {
            localStorage.setItem('advancedQuestionTracking', JSON.stringify(advancedTracking));
        }

        function getRecentlyShownQuestions() {
            const recentQuestions = new Set();
            const sessionsToCheck = Math.min(advancedTracking.cooldownPeriod, advancedTracking.sessionHistory.length);
            
            for (let i = 0; i < sessionsToCheck; i++) {
                const session = advancedTracking.sessionHistory[i];
                if (session && session.questions) {
                    session.questions.forEach(qId => recentQuestions.add(qId));
                }
            }
            
            return Array.from(recentQuestions);
        }

        function calculateQuestionScore(questionId) {
            const occurrences = advancedTracking.occurrences[questionId] || 0;
            const lastShown = advancedTracking.lastShown[questionId] || 0;
            const currentTime = new Date().getTime();
            const timeSinceLastShown = currentTime - lastShown;
            
            // Factor de ocurrencias (menos veces mostrado = mayor prioridad)
            const occurrenceScore = 1 / (occurrences + 1);
            
            // Factor de tiempo (m√°s tiempo sin mostrar = mayor prioridad)
            const timeScore = timeSinceLastShown / (1000 * 60 * 60 * 24); // D√≠as desde √∫ltima vez
            
            return occurrenceScore * 100 + timeScore;
        }

        function registerNewSession(questionIds) {
            const session = {
                timestamp: new Date().getTime(),
                questions: questionIds,
                date: new Date().toISOString()
            };
            
            advancedTracking.sessionHistory.unshift(session);
            
            if (advancedTracking.sessionHistory.length > advancedTracking.maxSessionHistory) {
                advancedTracking.sessionHistory = advancedTracking.sessionHistory.slice(0, advancedTracking.maxSessionHistory);
            }
            
            saveAdvancedTracking();
        }

        function resetAllData() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar todo el historial de preguntas? Esta acci√≥n no se puede deshacer.')) {
                advancedTracking = {
                    version: TRACKING_VERSION,
                    occurrences: {},
                    sessionHistory: [],
                    lastShown: {},
                    cooldownPeriod: 3,
                    maxSessionHistory: 10
                };
                initializeTracking();
                showSuccess('Historial de preguntas reiniciado correctamente.');
            }
        }

        // Funci√≥n para seleccionar preguntas aleatorias
        function selectRandomQuestions(num, category) {
            let availableQuestions = questionsDB;
            
            if (category !== 'TODO') {
                availableQuestions = questionsDB.filter(q => q.category === category);
            }
            
            if (availableQuestions.length === 0) {
                return [];
            }

            // Obtener IDs de preguntas mostradas recientemente
            const recentlyShownIds = getRecentlyShownQuestions();
            
            // Separar en categor√≠as seg√∫n historial
            const neverShown = [];
            const eligibleForRepeat = [];
            const recentlyShown = [];
            
            availableQuestions.forEach(q => {
                if (advancedTracking.occurrences[q.id] === 0) {
                    neverShown.push(q);
                } else if (recentlyShownIds.includes(q.id)) {
                    recentlyShown.push(q);
                } else {
                    eligibleForRepeat.push(q);
                }
            });

            // Construir pool final priorizando nuevas preguntas
            let finalPool = [];
            
            // 1. Primero las nunca mostradas (mezcladas)
            finalPool = finalPool.concat(shuffleArray(neverShown));
            
            // 2. Luego las elegibles, ordenadas por prioridad
            eligibleForRepeat.sort((a, b) => {
                return calculateQuestionScore(b.id) - calculateQuestionScore(a.id);
            });
            finalPool = finalPool.concat(eligibleForRepeat);
            
            // 3. Solo si es necesario, incluir las recientes
            if (finalPool.length < num) {
                recentlyShown.sort((a, b) => {
                    return calculateQuestionScore(b.id) - calculateQuestionScore(a.id);
                });
                finalPool = finalPool.concat(recentlyShown);
            }

            // Elegir preguntas y mezclarlas
            const selected = finalPool.slice(0, Math.min(num, finalPool.length));
            const shuffled = shuffleArray(selected);
            
            // Registrar la sesi√≥n
            registerNewSession(shuffled.map(q => q.id));
            
            return shuffled;
        }

        // Funci√≥n para mezclar array
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Funci√≥n para iniciar quiz
        function startQuiz() {
            const numQuestions = parseInt(document.getElementById('numQuestions').value);
            const category = document.getElementById('category').value;
            
            // Seleccionar preguntas
            const selectedQuestions = selectRandomQuestions(numQuestions, category);
            
            if (selectedQuestions.length === 0) {
                alert('No hay preguntas disponibles para la categor√≠a seleccionada.');
                return;
            }
            
            // Preparar quiz
            currentQuiz.questions = selectedQuestions;
            currentQuiz.currentIndex = 0;
            currentQuiz.correctAnswers = 0;
            currentQuiz.incorrectAnswers = 0;
            currentQuiz.reviewItems = [];
            currentQuiz.startTime = new Date();
            
            // Cambiar vista
            elements.configSection.style.display = 'none';
            elements.quizSection.style.display = 'block';
            elements.resultsSection.style.display = 'none';
            
            // Mostrar primera pregunta
            showQuestion();
        }

        // Funci√≥n para mostrar pregunta actual
        function showQuestion() {
            const question = currentQuiz.questions[currentQuiz.currentIndex];
            
            // Incrementar contador y actualizar tiempo
            advancedTracking.occurrences[question.id] = (advancedTracking.occurrences[question.id] || 0) + 1;
            advancedTracking.lastShown[question.id] = new Date().getTime();
            saveAdvancedTracking();
            
            // Actualizar progreso
            const progress = ((currentQuiz.currentIndex + 1) / currentQuiz.questions.length) * 100;
            elements.progressFill.style.width = `${progress}%`;
            
            // Actualizar contador
            elements.questionCounter.textContent = `Pregunta ${currentQuiz.currentIndex + 1} de ${currentQuiz.questions.length}`;
            
            // Mostrar texto de pregunta
            elements.questionText.textContent = question.question;
            
            // Mostrar opciones
            elements.optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = `${String.fromCharCode(65 + index)}) ${option}`;
                button.onclick = () => selectOption(index);
                elements.optionsContainer.appendChild(button);
            });
            
            // Restablecer elementos
            elements.feedback.style.display = 'none';
            elements.motivationalMessage.textContent = '';
            elements.nextButton.classList.add('hidden');
        }

        // Funci√≥n para seleccionar opci√≥n
        function selectOption(selectedIndex) {
            const question = currentQuiz.questions[currentQuiz.currentIndex];
            const isCorrect = selectedIndex === question.correctAnswer;
            
            // Deshabilitar botones
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(button => button.disabled = true);
            
            // Marcar respuestas
            buttons[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                buttons[question.correctAnswer].classList.add('correct');
            }
            
            // Actualizar estad√≠sticas
            if (isCorrect) {
                currentQuiz.correctAnswers++;
            } else {
                currentQuiz.incorrectAnswers++;
                currentQuiz.reviewItems.push({
                    question: question.question,
                    correctAnswer: question.options[question.correctAnswer],
                    reasoning: question.reasoning
                });
            }
            
            // Mostrar feedback
            elements.feedback.className = `feedback ${isCorrect ? 'success' : 'error'}`;
            
            let feedbackText = isCorrect ? 
                '‚úÖ ¬°Correcto! ' : 
                `‚ùå Incorrecto. La respuesta correcta es: ${question.options[question.correctAnswer]}. `;
            
            feedbackText += question.reasoning;
            
            if (question.legalReference) {
                feedbackText += ` <a href="${question.legalReference}" target="_blank">Ver legislaci√≥n</a>`;
            }
            
            elements.feedback.innerHTML = feedbackText;
            elements.feedback.style.display = 'block';
            
            // Mostrar mensaje motivacional
            const phrases = isCorrect ? motivationalPhrases.correct : motivationalPhrases.incorrect;
            elements.motivationalMessage.textContent = phrases[Math.floor(Math.random() * phrases.length)];
            
            // Mostrar bot√≥n siguiente o resultados
            if (currentQuiz.currentIndex < currentQuiz.questions.length - 1) {
                elements.nextButton.classList.remove('hidden');
            } else {
                setTimeout(showResults, 2000);
            }
        }

        // Funci√≥n para ir a la siguiente pregunta
        function nextQuestion() {
            currentQuiz.currentIndex++;
            showQuestion();
        }

        // Funci√≥n para mostrar resultados
        function showResults() {
            currentQuiz.endTime = new Date();
            
            // Cambiar vista
            elements.configSection.style.display = 'none';
            elements.quizSection.style.display = 'none';
            elements.resultsSection.style.display = 'block';
            
            // Calcular estad√≠sticas
            const total = currentQuiz.questions.length;
            const percentage = Math.round((currentQuiz.correctAnswers / total) * 100);
            
            // Actualizar estad√≠sticas
            elements.correctCount.textContent = currentQuiz.correctAnswers;
            elements.incorrectCount.textContent = currentQuiz.incorrectAnswers;
            elements.scorePercentage.textContent = `${percentage}%`;
            
            // Mostrar temas a repasar
            elements.reviewItems.innerHTML = '';
            
            if (currentQuiz.reviewItems.length > 0) {
                currentQuiz.reviewItems.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'review-item';
                    div.innerHTML = `
                        <strong>${index + 1}. ${item.question}</strong><br>
                        <span style="color: var(--success)">Respuesta correcta:</span> ${item.correctAnswer}<br>
                        <span style="color: var(--text-secondary)">${item.reasoning || 'Sin explicaci√≥n disponible'}</span>
                    `;
                    elements.reviewItems.appendChild(div);
                });
            } else {
                elements.reviewItems.innerHTML = '<p style="text-align: center; color: var(--success)">¬°Perfecto! No hay temas que repasar.</p>';
            }
            
            // Mostrar tabla de ocurrencias
            elements.occurrenceTableBody.innerHTML = '';
            
            const sortedQuestions = [...questionsDB].sort((a, b) => a.id - b.id);
            sortedQuestions.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.id}</td>
                    <td>${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}</td>
                    <td>${advancedTracking.occurrences[q.id] || 0}</td>
                `;
                elements.occurrenceTableBody.appendChild(tr);
            });
            
            // Mensaje motivacional final
            const finalMessage = motivationalPhrases.final[Math.floor(Math.random() * motivationalPhrases.final.length)];
            elements.finalMessage.textContent = finalMessage;
        }

        // Funci√≥n para reiniciar quiz
        function resetQuiz() {
            elements.configSection.style.display = 'block';
            elements.quizSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
        }
    </script>
</body>
</html>
